<!DOCTYPE html>
 <html lang="en">
 

 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Online Product Management</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/customer_management.css">
  <link rel="stylesheet" href="css/order_history.css">
  <link rel="stylesheet" href="css/manage-online-products.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
 

  <script type="module">
  // Firebase Core and Services
  import {
  initializeApp
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
  getAuth,
  onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
  getFirestore,
  collection,
  doc,
  addDoc,
  updateDoc,
  deleteDoc,
  onSnapshot,
  query,
  orderBy,
  serverTimestamp,
  Timestamp,
  getDoc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import {
  getStorage,
  ref,
  uploadBytesResumable,
  getDownloadURL,
  deleteObject
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
 

  // Import the function
  import { initializeOnlineProductManagement } from './js/manage-online-products.js';
 

  const firebaseConfig = {
  apiKey: "AIzaSyBQj5rQmE77kKKGYixP8y3Hcimz8tiAqzQ",
  authDomain: "madhav-multyprint.firebaseapp.com",
  projectId: "madhav-multyprint",
  storageBucket: "madhav-multyprint.firebasestorage.app",
  messagingSenderId: "104988349637",
  appId: "1:104988349637:web:faf045b77c6786a4e70cac"
  };
 

  let app;
  let auth;
  let db;
  let storage;
  try {
  if (!window.firebaseAppInitialized) {
  app = initializeApp(firebaseConfig);
  window.firebaseAppInitialized = true;
  window.firebaseApp = app;
  console.log("Firebase initialized (manage-online-products).");
  } else {
  app = window.firebaseApp;
  console.log("Firebase already initialized (manage-online-products).");
  }
  auth = getAuth(app);
  db = getFirestore(app);
  storage = getStorage(app);
 

  window.db = db;
  window.auth = auth;
  window.storage = storage;
  window.collection = collection;
  window.doc = doc;
  window.addDoc = addDoc;
  window.updateDoc = updateDoc;
  window.deleteDoc = deleteDoc;
  window.onSnapshot = onSnapshot;
  window.query = query;
  window.orderBy = orderBy;
  window.serverTimestamp = serverTimestamp;
  window.Timestamp = Timestamp;
  window.getDoc = getDoc;
  window.storageRef = ref;
  window.uploadBytesResumable = uploadBytesResumable;
  window.getDownloadURL = getDownloadURL;
  window.deleteObject = deleteObject;
 

  console.log("Firebase services made globally available (manage-online-products).");
 

  onAuthStateChanged(auth, (user) => {
  const page = window.location.pathname.split('/').pop() || 'index.html';
  if (!user && !page.toLowerCase().includes('login.html')) {
  window.location.replace('login.html');
  } else if (user) {
  console.log(`User logged in on ${page}. Initializing Online Product Management.`);
  setTimeout(() => {
  // Now you can call it directly because it's imported
  initializeOnlineProductManagement();
  console.log("Called initializeOnlineProductManagement.");
  }, 250);
  }
  });
  } catch (e) {
  console.error("Firebase setup error in HTML:", e);
  alert("App Initialization Error. Check console.");
  }
  </script>
  <style>
  .sortable-header {
  cursor: pointer;
  position: relative;
  padding-right: 20px;
  }
 

  .sort-arrow {
  position: absolute;
  right: 5px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 0.8em;
  color: #888;
  }
 

  .sort-arrow.asc {
  display: inline-block;
  }
 

  .sort-arrow.desc {
  display: inline-block;
  }
  </style>
 </head>
 

 <body>
  <div class="container">
  <div class="header">
  <i class="fas fa-store header-icon"></i>
  <h1>Online Product Management</h1>
  </div>
 

  <div class="breadcrumb-container">
  <a href="index.html">Home</a> / <span>Online Product Management</span>
  </div>
 

  <div class="filter-bar">
  <div class="filter-group">
  <button id="addNewProductBtn" class="button add-new-button">
  <i class="fas fa-plus"></i> Add New Online Product
  </button>
  </div>
  <div class="filter-group">
  <label for="filterSearch"><i class="fas fa-search"></i> Search:</label>
  <input type="text" id="filterSearch" placeholder="Name, Category...">
  </div>
  <div class="filter-group filter-sort">
  <label for="sort-products"><i class="fas fa-sort"></i> Sort by:</label>
  <select id="sort-products">
  <option value="createdAt_desc">Newest First</option>
  <option value="createdAt_asc">Oldest First</option>
  <option value="productName_asc">Name (A-Z)</option>
  <option value="productName_desc">Name (Z-A)</option>
  <option value="pricing.rate_asc">Rate (Low-High)</option>
  <option value="pricing.rate_desc">Rate (High-Low)</option>
  </select>
  </div>
  <div class="filter-group">
  <button id="clearFiltersBtn" class="button clear-filters-button"
  title="Clear search and reset sort">
  <i class="fas fa-times"></i> Clear
  </button>
  </div>
  </div>
 

  <div class="table-container">
  <table id="productTable">
  <thead>
  <tr>
  <th style="width: 18%;">Name</th>
  <th style="width: 12%;">Category</th>
  <th style="text-align: right; width: 8%;" class="sortable-header"
  data-sort="pricing.rate">
  Rate
  <span class="sort-arrow asc" style="display: none;">&#9650;</span>
  <span class="sort-arrow desc" style="display: none;">&#9660;</span>
  </th>
  <th style="text-align: center; width: 7%;">Unit</th>
  <th style="text-align: center; width: 7%;">Enabled</th>
  <th style="text-align: center; width: 10%;">Date Added</th>
  <th style="text-align: right; width: 9%;">Current Stock</th>
  <th style="text-align: right; width: 9%;">Margin %</th>
  <th style="text-align: center; width: 18%;">Actions</th>
  </tr>
  </thead>
  <tbody id="productTableBody">
  <tr>
  <td colspan="9" id="loadingMessage">Loading online products...</td>
  </tr>
  </tbody>
  </table>
  </div>
  </div>
 

  <div id="productModal" class="modal">
  <div class="modal-content large-modal">
  <span class="close-btn" id="closeProductModal" title="Close">&times;</span>
  <h2 id="modalTitle"><i class="fas fa-box-open info-icon"></i> Add New Online Product</h2>
 

  <form id="productForm">
  <input type="hidden" id="editProductId">
  <input type="hidden" id="existingImageUrls" value="[]">
  <input type="hidden" id="existingDiagramUrl">
 

  <div class="product-form-grid">
 

  <div class="form-column">
  <fieldset>
  <legend><i class="fas fa-info-circle"></i> Basic Details</legend>
  <div class="form-group">
  <label for="productName">Product Name <span class="required">*</span>:</label>
  <input type="text" id="productName" required placeholder="Name shown on website">
  </div>
  <div class="form-group">
  <label for="productCategory">Category/Group <span class="required">*</span>:</label>
  <input type="text" id="productCategory" required
  placeholder="e.g., Wedding Card, Flex Banner">
  </div>
  <div class="form-group">
  <label for="productUnit">Unit <span class="required">*</span>:</label>
  <select id="productUnit" required>
  <option value="">-- Select Unit --</option>
  <option value="Qty">Qty</option>
  <option value="Sq Feet">Sq Feet</option>
  <option value="Nos">Nos</option>
  </select>
  </div>
  <div class="form-group">
  <label for="productDescription">Description:</label>
  <textarea id="productDescription" rows="4"
  placeholder="Product details shown to customer"></textarea>
  </div>
  <div class="form-group">
  <label for="isEnabled">
  <input type="checkbox" id="isEnabled" checked> Show on Website (Enabled)
  </label>
  </div>
  </fieldset>
 

  <div id="image-upload-section">
  <h3><i class="fas fa-images"></i> Product Images</h3>
  <div class="form-group">
  <label for="productImages">Select Images (Max 4):</label>
  <input type="file" id="productImages" multiple
  accept="image/png, image/jpeg, image/webp">
  <small>Select new images to add or replace existing ones.</small>
  </div>
  <label>Image Previews (Click <span style="color:red; font-weight:bold;">&times;</span> to
  remove):</label>
  <div id="image-preview-area"></div>
  <div id="upload-progress-info" style="font-size: 0.9em; margin-top: 10px; min-height: 1.2em;">
  </div>
  </div>
 

  <fieldset>
  <legend><i class="fas fa-drafting-compass"></i> Product Diagram</legend>
  <div class="form-group">
  <label for="productDiagram">Upload Diagram (Optional):</label>
  <input type="file" id="productDiagram" accept=".pdf,.png,.jpg,.jpeg,.webp">
  <small>PDF or Image file. Agents can download this.</small>
  <div id="diagram-link-area" style="margin-top: 10px; display: none;">
  <label style="font-weight:normal; font-size:0.9em;">Current Diagram:</label>
  <a href="#" id="viewDiagramLink" target="_blank" rel="noopener noreferrer"
  style="font-size:0.9em; word-break: break-all;">View/Download</a>
  <button type="button" id="removeDiagramBtn" class="button small-button danger-button"
  style="margin-left: 10px; padding: 3px 6px; font-size: 0.8em;" title="Remove Diagram"><i
  class="fas fa-times"></i> Remove</button>
  </div>
  <div id="diagram-upload-progress" style="font-size: 0.9em; margin-top: 5px; min-height: 1.2em;">
  </div>
  </div>
  </fieldset>
 

  </div>
  <div class="form-column">
  <fieldset>
  <legend><i class="fas fa-dollar-sign"></i> Price Details</legend>
 

  <div class="form-group price-group">
  <label for="productPurchasePrice">Purchase Price:</label>
  <input type="number" id="productPurchasePrice" placeholder="0.00" step="0.01" min="0">
  </div>
  <div class="form-group">
  <label for="productGstRate">GST Rate (%):</label>
  <input type="number" id="productGstRate" placeholder="e.g., 18" step="0.01" min="0"
  max="100">
  </div>
  <hr style="margin: 20px 0;">
 

  <div id="priceTabsContainer" class="price-tabs">
  <button type="button" class="price-tab-btn active" data-rate-type="online">Online</button>
  <button type="button" class="price-tab-btn" data-rate-type="retail">Retail</button>
  <button type="button" class="price-tab-btn" data-rate-type="agent">Agent</button>
  <button type="button" class="price-tab-btn" data-rate-type="reseller">Wholesale</button>
  </div>
 

  <div class="form-group price-group">
  <label for="currentRateInput" id="currentRateLabel">Online Customer Rate*:</label>
  <input type="number" id="currentRateInput" required placeholder="0.00" step="0.01"
  min="0">
  <small>Rate for the selected type above.</small>
  </div>
 

  <div id="applyRateCheckboxesContainer" class="apply-rate-checkboxes">
  </div>
 

  <hr style="margin: 20px 0;">
 

  <div class="form-group sq-feet-only price-group" style="display: none;">
  <label for="productMinOrderValue">Min. Order Value (Sq Ft Only):</label>
  <input type="number" id="productMinOrderValue" placeholder="e.g., 300" step="0.01"
  min="0">
  </div>
 

  <div class="form-group price-group">
  <label for="productMrp">M.R.P.:</label>
  <input type="number" id="productMrp" placeholder="0.00" step="0.01" min="0">
  </div>
 

  </fieldset>
 

  <fieldset id="wedding-card-fields" style="display: none;">
  <legend>Wedding Card Charges</legend>
  <div class="form-group price-group"><label for="designCharge">Design Charge:</label><input
  type="number" id="designCharge" placeholder="0.00" step="0.01" min="0"></div>
  <div class="form-group price-group"><label for="printingCharge">Printing Charge
  (Base):</label><input type="number" id="printingCharge" placeholder="e.g., 700 per 100"
  step="0.01" min="0"></div>
  <div class="form-group price-group"><label for="transportCharge