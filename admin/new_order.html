<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New/Edit Order</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/new_order.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script type="module">
        // --- Firebase App and Auth Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        // --- Firestore Imports (Ensure all needed functions are here) ---
        import {
            getFirestore, collection, addDoc, doc, updateDoc, getDocs, query,
            where, getDoc, orderBy, limit, Timestamp, arrayUnion, serverTimestamp,
            runTransaction
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // **** Your Firebase Configuration ****
        const firebaseConfig = {
          apiKey: "AIzaSyBQj5rQmE77kKKGYixP8y3Hcimz8tiAqzQ", // Replace with your actual config
          authDomain: "madhav-multyprint.firebaseapp.com",   // Replace with your actual config
          projectId: "madhav-multyprint",                // Replace with your actual config
          storageBucket: "madhav-multyprint.appspot.com",   // Replace with your actual config
          messagingSenderId: "104988349637",             // Replace with your actual config
          appId: "1:104988349637:web:faf045b77c6786a4e70cac" // Replace with your actual config
        };
        // !!!!! MAKE SURE THESE VALUES ARE CORRECT !!!!!

        let app; let auth; let db;
        try {
            // Initialize Firebase App (only once per page load)
            if (!window.firebaseAppInitialized) {
                app = initializeApp(firebaseConfig);
                window.firebaseAppInitialized = true;
                window.firebaseApp = app; // Store globally
                console.log("Firebase initialized on new_order.html (Minimal JS Setup)");
            } else {
                app = window.firebaseApp; // Use existing instance
                console.log("Firebase already initialized (Minimal JS Setup)");
            }
            auth = getAuth(app);
            db = getFirestore(app);

            // --- Make Firebase/Firestore functions globally available for new_order.js ---
            // This is needed because the JS file uses setTimeout and might access window later
            window.db = db;
            window.auth = auth;
            window.collection = collection;
            window.addDoc = addDoc;
            window.doc = doc;
            window.updateDoc = updateDoc;
            window.getDocs = getDocs;
            window.query = query;
            window.where = where;
            window.getDoc = getDoc;
            window.orderBy = orderBy;
            window.limit = limit;
            window.Timestamp = Timestamp;
            window.arrayUnion = arrayUnion;
            window.serverTimestamp = serverTimestamp;
            window.runTransaction = runTransaction;

            console.log("Firestore functions made global for new_order.js.");

            // Authentication State Check
            onAuthStateChanged(auth, (user) => {
                const currentPage = window.location.pathname.split('/').pop().toLowerCase() || 'index.html';
                if (!user && currentPage !== 'login.html') {
                    console.log("User not logged in. Redirecting...");
                    window.location.replace('login.html'); // Ensure correct path to login.html
                } else if (user) {
                    console.log(`User logged in on ${currentPage}. new_order.js will initialize.`);
                    // Note: new_order.js uses setTimeout to initialize its logic
                }
            });
            // Function to get current user if needed by other scripts
            window.getCurrentUser = () => auth.currentUser;

        } catch(e) {
            console.error("Firebase setup / Auth check error in HTML:", e);
            alert("Error loading application configuration in HTML.");
        }
    </script>
    </head>
<body>
    <div class="container">
        <div class="header" id="formHeader">
            <i class="fas fa-file-alt header-icon"></i>
            <span id="headerText">New Order</span>
        </div>

        <div class="breadcrumb">
            <a href="order_history.html">Order History</a> / <span id="breadcrumbAction">New Order</span>
        </div>

        <form id="newOrderForm">
            <input type="hidden" id="editOrderId" name="editOrderId">
            <input type="hidden" id="selectedCustomerId" name="selectedCustomerId">

            <div class="form-layout-columns">
                 <div class="form-column">
                     <div class="form-section-card">
                         <div class="section-title">1. Customer Details</div>
                         <div class="form-row">
                             <div class="form-group form-group-half suggestions-box">
                                 <label for="full_name">Full Name *</label>
                                 <input type="text" id="full_name" name="full_name" required autocomplete="off" placeholder="Search or enter customer name...">
                                 <div id="customer-suggestions-name" class="suggestions-list"><ul></ul></div>
                             </div>
                             <div class="form-group form-group-half suggestions-box">
                                 <label for="whatsapp_no">WhatsApp No *</label>
                                 <input type="text" id="whatsapp_no" name="whatsapp_no" required autocomplete="off" placeholder="Search or enter WhatsApp no...">
                                 <div id="customer-suggestions-whatsapp" class="suggestions-list"><ul></ul></div>
                             </div>
                         </div>
                          <div class="form-row">
                             <div class="form-group form-group-half">
                                 <label for="address">Address</label>
                                 <input type="text" id="address" name="address" placeholder="Autofills or enter address">
                             </div>
                             <div class="form-group form-group-half">
                                 <label for="contact_no">Contact No</label>
                                 <input type="text" id="contact_no" name="contact_no" placeholder="Autofills or enter contact">
                             </div>
                          </div>
                          <div class="form-row">
                              <div class="form-group form-group-full" id="customerAccountLinkArea" style="margin-top: -10px; margin-bottom: 5px; display: none;">
                                  <a href="#" id="viewCustomerAccountLink" target="_blank" class="link-button">View Full Account Details</a>
                              </div>
                              <div class="form-group form-group-full" id="customerBalanceArea" style="display: none; font-size: 0.9em; margin-bottom: 5px;">
                                  Current Balance: <strong id="customerCurrentBalance"></strong>
                              </div>
                          </div>
                         <p class="info-text">*Search existing customer or enter details for a new one.</p>
                    </div>
                 </div>
                 <div class="form-column">
                     <div class="form-section-card">
                         <div class="section-title">2. Order Details</div>
                         <div class="form-row">
                             <div class="form-group form-group-half">
                                <label for="manual_order_id">Order ID (Manual)</label>
                                <input type="text" id="manual_order_id" name="manual_order_id" placeholder="Optional - Auto-generated if empty">
                            </div>
                             <div class="form-group form-group-half">
                                <label for="display_order_id">Order ID (System)</label>
                                <input type="text" id="display_order_id" name="display_order_id" readonly placeholder="Auto-generated or Existing">
                            </div>
                        </div>
                         <div class="form-row">
                             <div class="form-group form-group-half">
                                <label for="order_date">Order Date *</label>
                                <input type="date" id="order_date" name="order_date" required>
                            </div>
                            <div class="form-group form-group-half">
                                <label for="delivery_date">Delivery Date</label>
                                <input type="date" id="delivery_date" name="delivery_date">
                            </div>
                        </div>
                        <div class="form-row">
                             <div class="form-group form-group-half">
                                 <label for="orderStatusSelect">Status</label>
                                 <select id="orderStatusSelect" name="order_status" class="form-input status-select">
                                     <option value="Order Received">Order Received</option>
                                     <option value="Designing">Designing</option>
                                     <option value="Verification">Verification</option>
                                     <option value="Design Approved">Design Approved</option>
                                     <option value="Printing">Printing</option>
                                     <option value="Ready for Working">Ready for Working</option>
                                     <option value="Delivered">Delivered</option>
                                     <option value="Completed">Completed</option>
                                 </select>
                             </div>
                            <div class="form-group priority-group" style="flex-basis: 150px;">
                                 <label>Urgent?</label>
                                 <div class="radio-group">
                                       <label><input type="radio" name="urgent" value="Yes"> Yes</label>
                                      <label><input type="radio" name="urgent" value="No" checked> No</label>
                                  </div>
                             </div>
                        </div>
                         <div class="form-row">
                             <div class="form-group remarks-group form-group-full">
                                 <label for="remarks">Remarks</label>
                                <textarea id="remarks" name="remarks" placeholder="Any specific notes..."></textarea>
                            </div>
                         </div>
                     </div>
                 </div>
            </div>

            <div class="form-section-card">

                <div class="section-title">3. Product & Job Details</div>
                <div class="table-container order-items-table">
                    <table id="orderItemsTable">
                        <thead>
                            <tr>
                                <th style="width: 28%;">Product Name / Description *</th>
                                <th style="width: 10%;">Unit Type *</th>
                                <th style="width: 15%;" class="sq-feet-header hidden-col">Dimensions (W x H) *</th>
                                <th style="width: 8%;" class="sq-feet-header hidden-col">Unit *</th>
                                <th style="width: 9%;">Quantity *</th>
                                <th style="width: 13%;">Rate *</th>
                                <th style="width: 12%;">Amount</th>
                                <th style="width: 5%;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="orderItemsTableBody">
                            </tbody>
                    </table>
                </div>
                <button type="button" id="addItemBtn" class="button add-item-button"><i class="fas fa-plus"></i> Add Item</button>
            </div>

             <div class="form-section-card" id="calculationAndSummarySection">
                 <div class="order-summary-wrapper">
                    <div class="summary-left">
                        <div id="calculationPreviewArea" class="calculation-preview" style="display: none;">
                           <h4>Calculation Details:</h4>
                           <div id="calculationPreviewContent">
                               <p style="color:grey;">Add Sq Feet items to see calculations.</p>
                           </div>
                       </div>
                    </div>

                     <div class="summary-right">
                         <div class="section-title summary-title">4. Order Summary & Payment</div>
                         <div class="summary-grid">

                            <div class="summary-label">Subtotal:</div>
                            <div class="summary-value summary-subtotal">
                                ₹ <span id="summarySubtotal">0.00</span>
                            </div>


                            <label for="summaryDiscountPercent" class="summary-label">Discount (%):</label>
                            <input type="number" id="summaryDiscountPercent" class="summary-input" step="0.01" min="0" max="100" placeholder="%">

                            <label for="summaryDiscountAmount" class="summary-label">Discount Amount:</label>
                            <input type="number" id="summaryDiscountAmount" class="summary-input" step="0.01" min="0" placeholder="Amount">


                            <div class="summary-label summary-highlight-label">Final Amount:</div>
                            <div class="summary-value summary-final-amount">
                                ₹ <span id="summaryFinalAmount">0.00</span>
                            </div>


                            <label for="summaryAdvancePayment" class="summary-label">Advance Payment:</label>
                            <input type="number" id="summaryAdvancePayment" class="summary-input" step="0.01" min="0" placeholder="Amount Received">


                            <div class="summary-label summary-highlight-label">Total Balance Due:</div>
                            <div class="summary-value summary-balance-due">
                                ₹ <span id="summaryTotalBalance">0.00</span>
                            </div>
                        </div>
                         <div id="creditLimitWarning" class="error-message" style="display: none; margin-top: 15px; text-align:left;"></div>
                     </div>
                 </div>
            </div>


            <div class="button-container">
                <button type="button" onclick="window.location.href='order_history.html'" class="cancel-button">
                    Cancel
                </button>
                <button type="submit" class="save-button" id="saveOrderBtn">
                    <i class="fas fa-save"></i> <span>Save Order</span>
                </button>
            </div>
             <div id="formErrorMsg" class="error-message" style="display: none; margin-top: 15px;"></div>
        </form>
    </div>

    <template id="item-row-template">
        <tr class="item-row">
            <td data-label="Product Name / Description">
                <input type="text" class="form-input product-name" placeholder="Search product..." required autocomplete="off">
                <textarea class="form-input item-description-input" rows="1" placeholder="Product description (optional)..." style="margin-top: 4px; font-size: 0.85em; height: auto;"></textarea>
            </td>
            <td data-label="Unit Type">
                 <select class="form-input unit-type-select">
                     <option value="Qty" selected>Qty</option>
                     <option value="Sq Feet">Sq Feet</option>
                 </select>
            </td>
            <td data-label="Dimensions" class="sq-feet-header hidden-col">
                 <div class="dimension-input-container sq-feet-input" style="display: none;">
                     <input type="number" step="0.01" class="form-input dimension-input width-input" placeholder="W" required>
                     <span style="padding: 0 2px;">x</span>
                     <input type="number" step="0.01" class="form-input dimension-input height-input" placeholder="H" required>
                 </div>
            </td>
            <td data-label="Dim Unit" class="sq-feet-header hidden-col">
                 <select class="form-input dimension-unit-select sq-feet-input" style="display: none;">
                     <option value="feet" selected>Feet</option>
                     <option value="inches">Inches</option>
                 </select>
            </td>
            <td data-label="Quantity">
                 <input type="number" step="1" class="form-input quantity-input" placeholder="Qty" min="1" value="1" required>
            </td>
            <td data-label="Rate">
                 <div class="rate-input-wrapper">
                     <input type="number" step="0.01" class="form-input rate-input" placeholder="Rate" required>
                 </div>
            </td>
            <td data-label="Amount" style="text-align: right; font-weight: 600; vertical-align: middle;">
                 ₹<span class="item-amount">0.00</span>
            </td>
            <td data-label="Action" style="text-align: center; vertical-align: middle;">
                 <button type="button" class="button delete-item-btn" title="Remove Item"><i class="fas fa-trash-alt"></i></button>
            </td>
        </tr>
    </template>
    <div id="whatsapp-reminder-popup" class="popup-overlay">
         <div class="popup-content">
             <button id="popup-close-btn" class="popup-close" title="Close">&times;</button>
             <h4>Order Saved Successfully!</h4>
             <p>Send update to customer?</p>
             <div id="whatsapp-message-preview" class="message-preview"></div>
             <a href="#" id="whatsapp-send-link" class="button whatsapp-send-btn" target="_blank">
                 <i class="fab fa-whatsapp"></i> Send on WhatsApp
             </a>
         </div>
    </div>

    <script src="js/new_order.js" type="module" defer></script>

</body>
</html>