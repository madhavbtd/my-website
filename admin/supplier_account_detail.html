<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supplier Account Details</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <link rel="stylesheet" href="css/supplier_account_detail.css">

    <script type="module">
        import { auth } from './js/firebase-init.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { initializeSupplierDetailPage } from './js/supplier_account_detail.js'; // Import the initialization function

        console.log("Inline script: Setting up Auth listener...");

        onAuthStateChanged(auth, (user) => {
            const mainContent = document.getElementById('supplierAccountDetailContent');
            const loadingIndicator = document.getElementById('pageLoadingIndicator'); // Use a dedicated loading indicator

            if (loadingIndicator) loadingIndicator.style.display = 'flex'; // Show loading indicator

            if (user) {
                console.log("Inline script: User is signed in. User ID:", user.uid);
                // User is signed in, proceed to initialize the page content
                if (mainContent) {
                    console.log("Inline script: Calling initializeSupplierDetailPage...");
                     try {
                        // Initialize the detail page logic now that user is confirmed
                        initializeSupplierDetailPage(); // Call the main function from the JS file
                        // Hide loading indicator AFTER initialization attempts (or within the function)
                        // if (loadingIndicator) loadingIndicator.style.display = 'none'; // Moved inside initialize or its load functions
                    } catch (error) {
                        console.error("Error during page initialization:", error);
                        if (mainContent) {
                            mainContent.innerHTML = `<div class="error-message-area" style="display:block; text-align: center; padding: 20px;">Failed to initialize page content. Please try refreshing. Error: ${error.message}</div>`;
                            mainContent.style.visibility = 'visible'; // Make error visible
                        }
                         if (loadingIndicator) loadingIndicator.style.display = 'none';
                    }

                } else {
                     console.error("Inline script: Main content container not found!");
                     if (loadingIndicator) loadingIndicator.style.display = 'none';
                     // Display error more prominently if possible
                     document.body.innerHTML = `<div style="padding: 20px; text-align: center; color: red;">Error: Page structure is broken. Cannot load supplier details.</div>`;
                }

            } else {
                console.log("Inline script: User is signed out.");
                // User is signed out, redirect to login page
                if (loadingIndicator) loadingIndicator.style.display = 'none'; // Hide loading indicator
                window.location.href = 'index.html'; // Redirect to your login page
            }
        });
    </script>

</head>
<body>
    <div id="pageLoadingIndicator" style="display: flex; justify-content: center; align-items: center; padding: 50px; font-size: 1.2em; color: var(--dark-gray);">
        <i class="fas fa-spinner fa-spin"></i>&nbsp; Loading Supplier Details...
    </div>

    <div class="container" id="supplierAccountDetailContent" style="visibility: hidden;">

        <div class="header">
            <i class="fas fa-user-tie header-icon"></i>
            <h1>Supplier Account: <span id="supplierNameHeader">Loading...</span></h1>
        </div>

        <div class="breadcrumb-container">
            <a href="dashboard.html">Dashboard</a> / <a href="supplier_management.html">Suppliers</a> / <span id="breadcrumbSupplierName">Account Details</span>
        </div>

        <div id="generalErrorDisplay" class="error-message-area" style="display: none;"></div>

        <div class="actions-bar">
            <button id="editSupplierBtn" class="button edit-button"><i class="fas fa-edit"></i> Edit Details</button>
            <button id="recordPaymentBtn" class="button payment-button"><i class="fas fa-money-check-alt"></i> Record Payment</button>
            <button id="addAdjustmentBtn" class="button adjustment-button"><i class="fas fa-balance-scale"></i> Add Adjustment</button>
            <button id="toggleStatusBtn" class="button status-toggle-button"><i class="fas fa-power-off"></i> Toggle Status</button> <button id="deleteSupplierBtn" class="button delete-button"><i class="fas fa-trash-alt"></i> Delete Supplier</button>
            <a href="supplier_management.html" class="button back-button"><i class="fas fa-arrow-left"></i> Back to List</a>
        </div>

        <div class="info-grid">
            <div class="info-box">
                <h2><i class="fas fa-info-circle"></i> Supplier Details</h2>
                <p><strong>Contact Person:</strong> <span id="supplierContactPerson">Loading...</span></p>
                <p><strong>Mobile:</strong> <span id="supplierMobile">Loading...</span></p>
                <p><strong>Email:</strong> <span id="supplierEmail">Loading...</span></p>
                <p><strong>Address:</strong> <span id="supplierAddress" style="white-space: pre-wrap;">Loading...</span></p>
                <p><strong>GST No.:</strong> <span id="supplierGst">Loading...</span></p>
                <p><strong>PAN No.:</strong> <span id="supplierPan">Loading...</span></p>
                 <p><strong>Status:</strong> <span id="supplierStatusBadge" class="status-badge">Loading...</span></p>
            </div>

            <div class="info-box">
                <h2><i class="fas fa-calculator"></i> Account Summary</h2>
                <p><strong>Total PO Value:</strong> <span id="summaryTotalPoValue">Calculating...</span></p>
                <p><strong>Total Paid:</strong> <span id="summaryTotalPaid">Calculating...</span></p>
                <p><strong>Total Adjustments:</strong> <span id="summaryTotalAdjustments">Calculating...</span></p>
                <p><strong>Balance Due:</strong> <span id="summaryBalance" class="balance-zero">Calculating...</span></p>
                <p><strong>Last Payment Date:</strong> <span id="summaryLastPaymentDate">N/A</span></p>
                <p><strong>Last PO Date:</strong> <span id="summaryLastPoDate">N/A</span></p>
                 <p><strong>Account Opened:</strong> <span id="supplierCreationDate">Loading...</span></p>
            </div>

            <div class="info-box">
                <h2><i class="fas fa-sticky-note"></i> Remarks / Notes</h2>
                 <span id="supplierRemarksNotes" style="display: block; white-space: pre-wrap; font-size: 0.95em; color: #555; line-height: 1.6; min-height: 50px;">Loading...</span>
            </div>
        </div>

        <div class="history-section">
            <h2><i class="fas fa-book"></i> Account Ledger</h2>
            <div class="table-container">
                <div id="ledgerLoadingIndicator" style="padding: 20px; text-align: center; color: var(--text-muted); display: none;">Loading ledger entries...</div>
                 <div id="ledgerErrorDisplay" class="error-message-area" style="display: none; margin: 10px;"></div>
                <table id="accountLedgerTable" class="details-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Transaction Type</th>
                            <th>Details</th>
                            <th class="number-cell">Debit</th>
                            <th class="number-cell">Credit</th>
                            <th class="number-cell">Balance</th>
                        </tr>
                    </thead>
                    <tbody id="accountLedgerTableBody">
                        <tr><td colspan="6" style="text-align: center; padding: 20px; color: var(--text-muted);">Loading ledger...</td></tr>
                    </tbody>
                </table>
                 <div id="ledgerEmptyMessage" style="padding: 20px; text-align: center; color: var(--text-muted); display: none;">No ledger entries found.</div>
            </div>
        </div>

    </div> <div id="editSupplierModal" class="modal">
        <div class="modal-content large-modal"> <div class="modal-header">
                <h2><i class="fas fa-edit info-icon"></i> Edit Supplier Details</h2>
                <span class="close-btn" id="closeEditSupplierModal" title="Close">&times;</span>
            </div>
            <div class="modal-body">
                <div id="editSupplierError" class="error-message" style="display: none;"></div>
                <form id="editSupplierForm">
                    <div class="form-group">
                        <label for="editSupplierName">Supplier Name <span class="required">*</span></label>
                        <input type="text" id="editSupplierName" required>
                    </div>
                    <div class="form-group">
                        <label for="editSupplierContactPerson">Contact Person</label>
                        <input type="text" id="editSupplierContactPerson">
                    </div>
                    <div class="form-group">
                        <label for="editSupplierMobile">Mobile Number <span class="required">*</span></label>
                        <input type="tel" id="editSupplierMobile" required>
                    </div>
                    <div class="form-group">
                        <label for="editSupplierEmail">Email</label>
                        <input type="email" id="editSupplierEmail">
                    </div>
                    <div class="form-group full-width"> <label for="editSupplierAddress">Address</label>
                        <textarea id="editSupplierAddress" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editSupplierGst">GST No.</label>
                        <input type="text" id="editSupplierGst">
                     </div>
                     <div class="form-group">
                        <label for="editSupplierPan">PAN No.</label>
                        <input type="text" id="editSupplierPan">
                    </div>
                    <div class="form-group full-width"> <label for="editSupplierRemarks">Remarks / Notes</label>
                        <textarea id="editSupplierRemarks" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-actions">
                <button type="button" class="button cancel-button" id="cancelEditSupplier"><i class="fas fa-times"></i> Cancel</button>
                <button type="submit" form="editSupplierForm" class="button submit-button"><i class="fas fa-save"></i> Save Changes</button>
            </div>
        </div>
    </div>

    <div id="recordPaymentModal" class="modal">
        <div class="modal-content">
             <div class="modal-header">
                <h2><i class="fas fa-money-check-alt success-icon"></i> Record Payment for <span id="paymentSupplierName"></span></h2>
                <span class="close-btn" id="closeRecordPaymentModal" title="Close">&times;</span>
            </div>
            <div class="modal-body">
                 <div id="paymentMadeError" class="error-message" style="display: none;"></div>
                 <form id="recordPaymentForm">
                    <div class="form-group">
                        <label for="paymentAmountPaid">Amount Paid <span class="required">*</span></label>
                        <input type="number" id="paymentAmountPaid" step="0.01" min="0" required>
                    </div>
                     <div class="form-group">
                        <label for="paymentDate">Payment Date <span class="required">*</span></label>
                        <input type="date" id="paymentDate" required>
                    </div>
                    <div class="form-group">
                        <label for="paymentMethod">Payment Method</label>
                        <select id="paymentMethod">
                            <option value="Cash">Cash</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Cheque">Cheque</option>
                            <option value="UPI">UPI</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                     <div class="form-group">
                        <label for="paymentReference">Reference / Notes (Optional)</label>
                        <textarea id="paymentReference" rows="2"></textarea>
                    </div>
                    </form>
            </div>
            <div class="modal-actions">
                <button type="button" class="button cancel-button" id="cancelPaymentBtn"><i class="fas fa-times"></i> Cancel</button>
                <button type="submit" form="recordPaymentForm" class="button submit-button"><i class="fas fa-check-circle"></i> Record Payment</button>
            </div>
        </div>
    </div>

    <div id="addAdjustmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-balance-scale warning-icon"></i> Add Account Adjustment for <span id="adjustmentSupplierName"></span></h2>
                 <span class="close-btn" id="closeAdjustmentModal" title="Close">&times;</span>
            </div>
             <div class="modal-body">
                 <div id="adjustmentError" class="error-message" style="display: none;"></div>
                 <form id="addSupplierAdjustmentForm">
                     <div class="form-group">
                         <label>Adjustment Type <span class="required">*</span></label>
                         <div>
                             <input type="radio" id="adjustmentTypeDebit" name="adjustmentType" value="debit" required checked>
                             <label for="adjustmentTypeDebit">Debit (Increase amount supplier owes you)</label>
                         </div>
                         <div>
                             <input type="radio" id="adjustmentTypeCredit" name="adjustmentType" value="credit" required>
                             <label for="adjustmentTypeCredit">Credit (Decrease amount supplier owes you / Increase amount you owe)</label>
                         </div>
                         <p class="help-text">Choose Debit for things like returns/refunds you receive. Choose Credit for discounts received, write-offs, or opening balances where you owe the supplier.</p>
                     </div>
                    <div class="form-group">
                        <label for="adjustmentAmount">Adjustment Amount <span class="required">*</span></label>
                        <input type="number" id="adjustmentAmount" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="adjustmentDate">Adjustment Date <span class="required">*</span></label>
                        <input type="date" id="adjustmentDate" required>
                    </div>
                    <div class="form-group">
                        <label for="adjustmentReason">Reason / Description <span class="required">*</span></label>
                        <textarea id="adjustmentReason" rows="2" required></textarea>
                    </div>
                 </form>
            </div>
            <div class="modal-actions">
                <button type="button" class="button cancel-button" id="cancelAdjustmentBtn"><i class="fas fa-times"></i> Cancel</button>
                <button type="submit" form="addSupplierAdjustmentForm" class="button submit-button"><i class="fas fa-plus-circle"></i> Add Adjustment</button>
            </div>
        </div>
    </div>

    <div id="confirmToggleModal" class="modal">
        <div class="modal-content small-modal">
            <div class="modal-header"> <h2 id="toggleModalTitle"><i class="fas fa-power-off"></i> Confirm Status Change</h2>
                <span class="close-btn" id="closeConfirmToggleModal" title="Close">&times;</span>
            </div>
            <div class="modal-body">
                 <div id="toggleError" class="error-message" style="display: none;"></div>
                <p>Are you sure you want to <strong id="toggleActionText"></strong> the supplier: <strong id="toggleSupplierName"></strong>?</p>
                <p id="toggleStatusWarning" class="warning-message" style="display: none;"></p> <div class="confirmation-check">
                    <input type="checkbox" id="confirmToggleCheckbox">
                    <label for="confirmToggleCheckbox">I understand and want to proceed.</label>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" id="cancelToggleBtn" class="button cancel-button"><i class="fas fa-times"></i> Cancel</button>
                <button type="button" id="confirmToggleBtn" class="button confirm-button" disabled><i class="fas fa-check"></i> Confirm Change</button>
            </div>
        </div>
    </div>

    <div id="confirmDeleteSupplierModal" class="modal">
        <div class="modal-content small-modal">
             <div class="modal-header"> <h2><i class="fas fa-trash-alt danger-icon"></i> Confirm Delete Supplier</h2>
                <span class="close-btn" id="closeConfirmDeleteSupplierModal" title="Close">&times;</span>
            </div>
             <div class="modal-body">
                <div id="deleteError" class="error-message" style="display: none;"></div>
                <p>Are you absolutely sure you want to permanently delete the supplier: <strong id="deleteSupplierName"></strong>?</p>
                <p class="warning-message">This action cannot be undone. Associated POs and payments will NOT be deleted automatically.</p>
                <div class="confirmation-check">
                    <input type="checkbox" id="confirmDeleteSupplierCheckbox">
                    <label for="confirmDeleteSupplierCheckbox">I understand the consequences and want to permanently delete this supplier.</label>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" id="cancelSupplierDeleteBtn" class="button cancel-button"><i class="fas fa-times"></i> Cancel</button>
                <button type="button" id="confirmSupplierDeleteBtn" class="button danger-button confirm-button" disabled><i class="fas fa-trash-alt"></i> Delete Permanently</button> </div>
        </div>
    </div>

    <script src="js/firebase-init.js" type="module"></script>
    <script src="js/supplier_account_detail.js" type="module" defer></script>

</body>
</html>