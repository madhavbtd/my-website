<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supplier Account Details</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <link rel="stylesheet" href="css/supplier_account_detail.css">

    <script type="module">
        // firebase-init.js से जरूरी चीजें इम्पोर्ट करें
        import { db, auth } from './js/firebase-init.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        // जरूरी मॉड्यूल्स को ग्लोबल बनाएं (यदि आवश्यक हो)
        window.db = db;
        window.auth = auth;

        // Auth स्थिति बदलनe पर सुनें
        onAuthStateChanged(auth, (user) => {
            const body = document.body;
            const content = document.getElementById('supplierAccountDetailContent');
            const loadingIndicator = document.getElementById('loadingIndicator');

            if (user) {
                // User is signed in.
                console.log("Auth state: User signed in.", user.uid);
                body.classList.remove('auth-error');
                if (loadingIndicator) loadingIndicator.style.display = 'flex';

                // === MODIFIED IMPORT AND CALL LOGIC ===
                import('./js/supplier_account_detail.js')
                    .then((module) => { // Get the entire module object
                        console.log("JS module loaded:", module); // Log the module object for debugging
                        // Check if the function exists on the module object
                        if (module && typeof module.initializeSupplierDetailPage === 'function') {
                            module.initializeSupplierDetailPage(); // Call the function via the module object
                        } else {
                            console.error("initializeSupplierDetailPage function not found in the loaded module object.");
                            if (content) content.innerHTML = '<p class="error-message">Error loading page logic (function missing). Please refresh.</p>';
                            body.style.visibility = 'visible';
                            if (loadingIndicator) loadingIndicator.style.display = 'none';
                        }
                    })
                    .catch(error => {
                        console.error("Error importing supplier_account_detail.js:", error);
                        if (content) content.innerHTML = `<p class="error-message">Failed to load page script: ${error.message}. Please check console and refresh.</p>`;
                        body.style.visibility = 'visible';
                        if (loadingIndicator) loadingIndicator.style.display = 'none';
                    });
                // === END OF MODIFIED LOGIC ===

            } else {
                // User is signed out.
                console.log("Auth state: User signed out.");
                if (loadingIndicator) loadingIndicator.style.display = 'none';
                body.classList.add('auth-error');
                body.style.visibility = 'visible';
                if (content) content.innerHTML = '<p class="error-message">You are not signed in. <a href="login.html">Please log in</a>.</p>';
            }
        });
    </script>

    <style>
        /* Simple Loading Indicator Style */
        #loadingIndicator {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999; font-size: 1.2em; color: #333; display: none; /* Initially hidden */
        }
        #loadingIndicator i { margin-right: 10px; }
        body { visibility: hidden; /* Hide body initially */ }
        body.auth-error { visibility: visible; }
    </style>

</head>
<body>

    <div id="loadingIndicator">
        <i class="fas fa-spinner fa-spin"></i> Loading Supplier Details...
    </div>

    <div id="supplierAccountDetailContent">
        <div class="container">
            <div class="page-header">
                <h1>Supplier Account: <span id="supplierNameHeader">...</span></h1>
                <a href="supplier_management.html" class="button back-button"><i class="fas fa-arrow-left"></i> Back to Suppliers</a>
            </div>

            <div id="generalErrorDisplay" class="error-message hidden"></div>

            <div class="actions-bar">
                <button type="button" id="editSupplierBtn" class="button info-button" disabled><i class="fas fa-edit"></i> Edit Details</button>
                <button type="button" id="recordPaymentBtn" class="button success-button" disabled><i class="fas fa-money-bill-wave"></i> Record Payment</button>
                <button type="button" id="addAdjustmentBtn" class="button purple-button" disabled><i class="fas fa-balance-scale"></i> Add Adjustment</button>
                <button type="button" id="toggleStatusBtn" class="button" disabled><i class="fas fa-power-off"></i> Toggle Status</button>
                <button type="button" id="deleteSupplierBtn" class="button danger-button" disabled><i class="fas fa-trash-alt"></i> Delete Supplier</button>
            </div>

            <div class="info-grid">
                <div class="info-box" id="supplierDetailsBox">
                    <h2><i class="fas fa-user-tie"></i> Supplier Details</h2>
                    <p><strong>Supplier ID:</strong> <span id="details-supplierId">N/A</span></p>
                    <p><strong>Name:</strong> <span id="details-name">N/A</span></p>
                    <p><strong>Company:</strong> <span id="details-company">N/A</span></p>
                    <p><strong>WhatsApp:</strong> <span id="details-whatsapp">N/A</span></p>
                    <p><strong>Contact No:</strong> <span id="details-contact">N/A</span></p>
                    <p><strong>Email:</strong> <span id="details-email">N/A</span></p>
                    <p><strong>GST No:</strong> <span id="details-gst">N/A</span></p>
                    <p><strong>Address:</strong> <span id="details-address">N/A</span></p>
                    <p><strong>Added On:</strong> <span id="details-addedOn">N/A</span></p>
                    <p><strong>Account Status:</strong> <span id="details-status" class="status-badge">N/A</span></p>
                </div>

                <div class="info-box" id="accountSummaryBox">
                    <h2><i class="fas fa-chart-line"></i> Account Summary</h2>
                    <p><strong>Total PO Value:</strong> <span id="summary-poValue">₹ 0.00</span></p>
                    <p><strong>Total Payments Made:</strong> <span id="summary-paymentsMade">₹ 0.00</span></p>
                    <p><strong>Total Adjustments (Debit):</strong> <span id="summary-adjustmentsDebit">₹ 0.00</span></p>
                    <p><strong>Total Adjustments (Credit):</strong> <span id="summary-adjustmentsCredit">₹ 0.00</span></p>
                    <p><strong>Outstanding Balance:</strong> <span id="summary-balance" class="balance-info">₹ 0.00</span></p>
                </div>

                <div class="info-box" id="remarksBox">
                    <h2><i class="fas fa-sticky-note"></i> Remarks / Notes</h2>
                    <p id="details-remarks">No remarks.</p>
                </div>
            </div>

            <div class="history-section" id="poHistorySection">
                <h2><i class="fas fa-receipt"></i> Purchase Orders (POs)</h2>
                <div class="table-container">
                    <table id="purchaseOrdersTable">
                        <thead>
                            <tr>
                                <th>PO Date</th>
                                <th>PO Number</th>
                                <th>Status</th>
                                <th class="text-right">Amount</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="5" class="text-center">Loading POs...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="history-section" id="ledgerSection">
                <h2><i class="fas fa-book-open"></i> Supplier Ledger</h2>
                <div class="table-container">
                    <table id="supplierLedgerTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th class="text-right">Debit (-)</th>
                                <th class="text-right">Credit (+)</th>
                                <th class="text-right">Running Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="6" class="text-center">Loading Ledger...</td></tr>
                        </tbody>
                    </table>
                </div>
                 <p class="text-muted text-center small">Balance calculated chronologically. Debit increases amount owed by you, Credit decreases it.</p>
            </div>

        </div> </div> <div id="editSupplierModal" class="modal">
        <div class="modal-content modal-lg">
            <span class="close-btn" title="Close">&times;</span>
            <h2><i class="fas fa-edit info-icon"></i> Edit Supplier Details</h2>
            <form id="editSupplierForm">
                <div class="form-group">
                    <label for="editSupplierName">Name <span class="required">*</span></label>
                    <input type="text" id="editSupplierName" required>
                </div>
                <div class="form-group">
                    <label for="editSupplierCompany">Company</label>
                    <input type="text" id="editSupplierCompany">
                </div>
                <div class="form-group">
                    <label for="editSupplierWhatsapp">WhatsApp No</label>
                    <input type="tel" id="editSupplierWhatsapp">
                </div>
                <div class="form-group">
                    <label for="editSupplierContact">Other Contact No</label>
                    <input type="tel" id="editSupplierContact">
                </div>
                <div class="form-group">
                    <label for="editSupplierEmail">Email Address</label>
                    <input type="email" id="editSupplierEmail">
                </div>
                 <div class="form-group">
                    <label for="editSupplierGst">GST No</label>
                    <input type="text" id="editSupplierGst">
                </div>
                <div class="form-group">
                    <label for="editSupplierAddress">Address</label>
                    <textarea id="editSupplierAddress" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="editSupplierRemarks">Remarks/Notes</label>
                    <textarea id="editSupplierRemarks" rows="3"></textarea>
                </div>
                <div id="editSupplierError" class="error-message hidden"></div>
                <div class="modal-actions">
                    <button type="button" class="button cancel-button">Cancel</button>
                    <button type="submit" id="saveSupplierChangesBtn" class="button warning-button"><i class="fas fa-save"></i> Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="recordPaymentModal" class="modal">
        <div class="modal-content small-modal">
            <span class="close-btn" title="Close">&times;</span>
            <h2><i class="fas fa-money-bill-wave success-icon"></i> Record Payment</h2>
            <form id="recordPaymentForm">
                <div class="form-group">
                    <label for="paymentAmount">Payment Amount <span class="required">*</span></label>
                    <input type="number" id="paymentAmount" step="0.01" min="0.01" required>
                </div>
                <div class="form-group">
                    <label for="paymentDate">Payment Date <span class="required">*</span></label>
                    <input type="date" id="paymentDate" required>
                </div>
                <div class="form-group">
                    <label for="paymentReference">Reference / Notes</label>
                    <input type="text" id="paymentReference" placeholder="e.g., Bank Transfer ID, Check No.">
                </div>
                 <div id="recordPaymentError" class="error-message hidden"></div>
                <div class="modal-actions">
                    <button type="button" class="button cancel-button">Cancel</button>
                    <button type="submit" id="submitPaymentBtn" class="button success-button"><i class="fas fa-check"></i> Record Payment</button>
                </div>
            </form>
        </div>
    </div>

    <div id="addAdjustmentModal" class="modal">
        <div class="modal-content small-modal">
            <span class="close-btn" title="Close">&times;</span>
            <h2><i class="fas fa-balance-scale purple-icon"></i> Add Ledger Adjustment</h2>
            <form id="addAdjustmentForm">
                 <div class="form-group">
                    <label>Adjustment Type <span class="required">*</span></label>
                    <div>
                        <input type="radio" id="adjustmentTypeDebit" name="adjustmentType" value="debit" required checked>
                        <label for="adjustmentTypeDebit">Debit (Increase amount owed by you)</label>
                    </div>
                    <div>
                        <input type="radio" id="adjustmentTypeCredit" name="adjustmentType" value="credit" required>
                        <label for="adjustmentTypeCredit">Credit (Decrease amount owed by you)</label>
                    </div>
                     <p>Example: Use Debit for purchase returns/refunds received. Use Credit for discounts received or write-offs.</p>
                </div>
                <div class="form-group">
                    <label for="adjustmentAmount">Adjustment Amount <span class="required">*</span></label>
                    <input type="number" id="adjustmentAmount" step="0.01" min="0.01" required>
                </div>
                <div class="form-group">
                    <label for="adjustmentDate">Adjustment Date <span class="required">*</span></label>
                    <input type="date" id="adjustmentDate" required>
                </div>
                <div class="form-group">
                    <label for="adjustmentDescription">Description / Reason <span class="required">*</span></label>
                    <input type="text" id="adjustmentDescription" required placeholder="e.g., Discount for early payment, Return Goods">
                </div>
                 <div id="addAdjustmentError" class="error-message hidden"></div>
                <div class="modal-actions">
                    <button type="button" class="button cancel-button">Cancel</button>
                    <button type="submit" id="submitAdjustmentBtn" class="button purple-button"><i class="fas fa-check"></i> Add Adjustment</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirmToggleStatusModal" class="modal">
        <div class="modal-content small-modal">
            <span class="close-btn" title="Close">&times;</span>
            <h2><i class="fas fa-power-off warning-icon"></i> Confirm Status Change</h2>
            <p>Are you sure you want to change the status of supplier: <strong id="toggleSupplierName"></strong> to <strong id="toggleSupplierNewStatus"></strong>?</p>
            <div id="toggleStatusWarning" class="warning-message hidden"></div>
             <div class="confirmation-check">
                 <input type="checkbox" id="confirmToggleStatusCheckbox">
                 <label for="confirmToggleStatusCheckbox">I understand and want to change the status.</label>
             </div>
            <div class="modal-actions">
                <button type="button" class="button cancel-button">Cancel</button>
                <button type="button" id="confirmToggleStatusBtn" class="button warning-button" disabled><i class="fas fa-check"></i> Confirm Change</button>
            </div>
        </div>
    </div>

    <div id="confirmDeleteSupplierModal" class="modal">
        <div class="modal-content small-modal">
            <span class="close-btn" title="Close">&times;</span>
            <h2><i class="fas fa-trash-alt danger-icon"></i> Confirm Delete Supplier</h2>
            <p>Are you absolutely sure you want to permanently delete the supplier: <strong id="deleteSupplierName"></strong>?</p>
            <p class="warning-message">This action cannot be undone. Associated POs and payments will NOT be deleted automatically.</p>
            <div class="confirmation-check">
                <input type="checkbox" id="confirmDeleteSupplierCheckbox">
                <label for="confirmDeleteSupplierCheckbox">I understand the consequences and want to permanently delete this supplier.</label>
            </div>
            <div class="modal-actions">
                <button type="button" class="button cancel-button">Cancel</button>
                <button type="button" id="confirmSupplierDeleteBtn" class="button danger-button" disabled><i class="fas fa-trash-alt"></i> Delete Permanently</button>
            </div>
        </div>
    </div>

    </body>
</html>