<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Management</title>
    <link rel="stylesheet" href="css/customer_management.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
    <div class="container">
        <div class="header">
            <i class="fas fa-users header-icon"></i>
            <h1>Customer Management</h1>
        </div>

        <div class="filter-bar">
             <div class="filter-group">
                 <button id="addNewCustomerBtn" class="button add-new-button">
                    <i class="fas fa-user-plus"></i> Add New Customer
                </button>
            </div>
             <div class="filter-group">
                <label for="filterSearch"><i class="fas fa-search"></i> Search:</label>
                <input type="text" id="filterSearch" placeholder="ID, Name, WhatsApp...">
            </div>
             <div class="filter-group filter-sort">
                <label for="sort-customers"><i class="fas fa-sort"></i> Sort by:</label>
                <select id="sort-customers">
                    <option value="createdAt_desc">Newest First</option>
                    <option value="createdAt_asc">Oldest First</option>
                    <option value="fullName_asc">Name (A-Z)</option>
                    <option value="fullName_desc">Name (Z-A)</option>
                    <option value="customCustomerId_asc">ID (Low-High)</option> <option value="customCustomerId_desc">ID (High-Low)</option> </select>
            </div>
            <div class="filter-group">
                 <button id="clearFiltersBtn" class="button clear-filters-button" title="Clear search and reset sort">
                    <i class="fas fa-times"></i> Clear
                 </button>
            </div>
        </div>

        <div class="table-container">
            <table id="customerTable">
                <thead>
                    <tr>
                        <th>Cust. ID</th> <th>Full Name</th>
                        <th>WhatsApp No</th>
                        <th>Contact No</th>
                        <th>Address</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="customerTableBody">
                    <tr>
                        <td colspan="6" id="loadingMessage">Loading customers...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="customerModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeCustomerModal" title="Close">&times;</span>
            <h2 id="modalTitle">Add New Customer</h2>
            <form id="customerForm">
                <input type="hidden" id="editCustomerId"> <div class="form-group">
                    <label for="customerFullName">Full Name <span class="required">*</span>:</label>
                    <input type="text" id="customerFullName" required>
                </div>
                <div class="form-group">
                     <label for="customerWhatsApp">WhatsApp No <span class="required">*</span>:</label>
                    <input type="tel" id="customerWhatsApp" required placeholder="e.g., 91XXXXXXXXXX">
                </div>
                <div class="form-group">
                    <label for="customerContact">Contact No:</label>
                    <input type="tel" id="customerContact" placeholder="Optional alternate number">
                </div>
                <div class="form-group">
                    <label for="customerAddress">Address:</label>
                    <textarea id="customerAddress" rows="3" placeholder="Optional address details"></textarea>
                </div>
                <div class="form-group" id="customIdDisplayArea" style="display: none;">
                     <label>Customer ID:</label>
                     <input type="text" id="generatedCustomId" readonly>
                 </div>


                <div class="modal-actions">
                    <button type="submit" id="saveCustomerBtn" class="button save-button">
                        <i class="fas fa-save"></i> <span>Save Customer</span> </button>
                     <button type="button" id="cancelCustomerBtn" class="button cancel-button">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        // Import necessary Firebase functions
        // Added runTransaction, getDoc, serverTimestamp
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, runTransaction, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- PASTE YOUR firebaseConfig HERE ---
        // Use the exact same config as new_order.html and order_history.html
        const firebaseConfig = {
          apiKey: "AIzaSyBQj5rQmE77kKKGYixP8y3Hcimz8tiAqzQ", // YOUR CONFIG
          authDomain: "madhav-multyprint.firebaseapp.com", // YOUR CONFIG
          projectId: "madhav-multyprint", // YOUR CONFIG
          storageBucket: "madhav-multyprint.appspot.com", // YOUR CONFIG
          messagingSenderId: "104988349637", // YOUR CONFIG
          appId: "1:104988349637:web:faf045b77c6786a4e70cac" // YOUR CONFIG
        };
        // --- END OF PASTE ---

        // Initialize Firebase and make functions globally available
         try {
            let app;
            if (!window.firebaseAppInitialized) {
                 app = initializeApp(firebaseConfig);
                 window.firebaseAppInitialized = true;
                 console.log("Firebase initialized on customer_management page.");
            } else {
                 console.log("Firebase already initialized (customer_management).");
            }
            const db = window.db || getFirestore(app || undefined);
            window.db = db;

            // Make Firestore functions globally available
            window.collection = collection;
            window.doc = doc;
            window.addDoc = addDoc;
            window.updateDoc = updateDoc;
            window.deleteDoc = deleteDoc;
            window.onSnapshot = onSnapshot;
            window.query = query;
            window.orderBy = orderBy;
            window.serverTimestamp = serverTimestamp;
            window.runTransaction = runTransaction; // Make transaction function available
            window.getDoc = getDoc; // Needed for transaction

            console.log("Firebase functions available globally for customer_management.");

        } catch (e) {
            console.error("Firebase initialization error (customer_management):", e);
            if (!window.db) {
                alert("Database connection error on customer page!");
                 const loadingCell = document.getElementById('loadingMessage');
                 if(loadingCell) loadingCell.textContent = 'Database connection error!';
            }
        }
    </script>

    <script src="js/customer_management.js" type="module" defer></script>

</body>
</html>