<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New/Edit Order</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/new_order.css"> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script type="module">
        // Import Firebase services
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        // Import other services like Firestore if needed by the page
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, getDocs, query, where, getDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"; // Added Firestore imports needed for original script

        // **** Your Firebase Configuration ****
         const firebaseConfig = {
           apiKey: "AIzaSyBQj5rQmE77kKKGYixP8y3Hcimz8tiAqzQ", // Your apiKey
           authDomain: "madhav-multyprint.firebaseapp.com", // Your authDomain
           projectId: "madhav-multyprint", // Your projectId
           storageBucket: "madhav-multyprint.appspot.com", // Your storageBucket
           messagingSenderId: "104988349637", // Your messagingSenderId
           appId: "1:104988349637:web:faf045b77c6786a4e70cac" // Your appId
         };

        let app;
        let auth;
        let db; // Example for Firestore

        try {
             // Initialize Firebase App (only once per page load)
             if (!window.firebaseAppInitialized) {
                 app = initializeApp(firebaseConfig);
                 window.firebaseAppInitialized = true;
                 window.firebaseApp = app; // Store globally
                 console.log("Firebase initialized on this page (new_order).");
             } else {
                 app = window.firebaseApp; // Use existing instance
                 console.log("Firebase already initialized on this page (new_order).");
             }
             auth = getAuth(app);
             db = getFirestore(app); // Initialize Firestore (or other services)
             window.db = db; // Make global if needed by other scripts on the page
             window.auth = auth; // Make auth global

             // Make other Firestore functions globally available if new_order.js needs them
             window.collection = collection;
             window.addDoc = addDoc;
             window.doc = doc;
             window.updateDoc = updateDoc;
             window.deleteDoc = deleteDoc;
             window.onSnapshot = onSnapshot;
             window.getDocs = getDocs;
             window.query = query;
             window.where = where;
             window.getDoc = getDoc;
             window.orderBy = orderBy;
             window.limit = limit;


             // ---->> Authentication State Check (Core Security) <<----
             onAuthStateChanged(auth, (user) => {
                 const currentPage = window.location.pathname.split('/').pop() || 'index.html'; // Get current file name

                 if (user) {
                     // User is logged in. Allow page to load.
                     console.log(`User is logged in on ${currentPage}:`, user.uid);
                     // Initialize page-specific functions if needed
                     // e.g., if (typeof initializeNewOrderForm === 'function') { initializeNewOrderForm(user); }

                 } else {
                     // User is not logged in.
                     console.log(`User is not logged in on ${currentPage}. Redirecting to login...`);
                     // Redirect to login.html from all protected pages (but NOT from login.html itself)
                     if (currentPage.toLowerCase() !== 'login.html') {
                        // Make sure 'login.html' path is correct relative to your files
                        window.location.replace('login.html');
                     }
                 }
             });
             // ---->> Auth check end <<----

             // --- Logout Link Logic (Include if a logout link exists on this page too) ---
             // Assuming no logout link on this specific page based on original code,
             // but you can add it here if needed, similar to index.html


             // --- Optional: Make user info available globally ---
             window.getCurrentUser = () => {
                 return auth.currentUser;
             };

        } catch(e) {
            console.error("Firebase setup / Auth check error:", e);
            alert("Error loading application. Please try again later."); // English alert
            // Optional: Redirect to login on critical error
            // if (window.location.pathname.split('/').pop().toLowerCase() !== 'login.html') {
            //    window.location.replace('login.html');
            // }
        }
    </script>
    </head>
<body>
    <div class="container">
        <div class="header" id="formHeader">
             <i class="fas fa-file-alt header-icon"></i>
             <span id="headerText">New Order</span>
        </div>

        <div class="breadcrumb">
            <a href="order_history.html">Order History</a> / <span>New/Edit Order</span>
        </div>
        <form id="newOrderForm">
            <input type="hidden" id="editOrderId" name="editOrderId">
            <input type="hidden" id="selectedCustomerId" name="selectedCustomerId">

            <div class="form-layout-columns">

                <div class="form-column">

                    <div class="form-section-card">
                        <div class="section-title">1. Customer Details</div>
                        <div class="form-row">
                            <div class="form-group form-group-half">
                                <label for="full_name">Full Name:</label>
                                <input type="text" id="full_name" name="full_name" required autocomplete="off" placeholder="Enter customer name...">
                                <div id="customer-suggestions-name" class="suggestions-box"></div>
                            </div>
                            <div class="form-group form-group-half">
                                <label for="address">Address:</label>
                                <input type="text" id="address" name="address" readonly placeholder="Autofills when customer selected">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group form-group-half">
                                <label for="whatsapp_no">WhatsApp No:</label>
                                <input type="text" id="whatsapp_no" name="whatsapp_no" required autocomplete="off" placeholder="Enter WhatsApp number...">
                                <div id="customer-suggestions-whatsapp" class="suggestions-box"></div>
                            </div>
                            <div class="form-group form-group-half">
                                <label for="contact_no">Contact No:</label>
                                <input type="text" id="contact_no" name="contact_no" readonly placeholder="Autofills when customer selected">
                            </div>
                        </div>
                        <p class="info-text">*New customer cannot be added here, only select an existing one.</p>
                    </div>

                    <div class="form-section-card">
                        <div class="section-title">3. Order Status</div>
                        <div id="order-status-group" class="form-group order-status-group">
                            <label><input type="checkbox" name="order_status" value="Order Received"><span>Order Received</span></label>
                            <label><input type="checkbox" name="order_status" value="Designing"><span>Designing</span></label>
                            <label><input type="checkbox" name="order_status" value="Verification"><span>Verification</span></label>
                            <label><input type="checkbox" name="order_status" value="Design Approved"><span>Design Approved</span></label>
                            <label><input type="checkbox" name="order_status" value="Printing"><span>Printing</span></label>
                            <label><input type="checkbox" name="order_status" value="Ready for Working"><span>Ready for Working</span></label> <label><input type="checkbox" name="order_status" value="Delivered"><span>Delivered</span></label>
                            <label><input type="checkbox" name="order_status" value="Completed"><span>Completed</span></label>
                        </div>
                         </div>

                </div><div class="form-column">

                    <div class="form-section-card">
                        <div class="section-title">2. Order Details</div>
                        <div class="form-row">
                             <div class="form-group form-group-half">
                                <label for="manual_order_id">Order ID (Manual):</label>
                                <input type="text" id="manual_order_id" name="manual_order_id" placeholder="Optional - Auto-generated if empty">
                            </div>
                             <div class="form-group form-group-half">
                                <label for="display_order_id">Order ID (System):</label>
                                <input type="text" id="display_order_id" name="display_order_id" readonly placeholder="Auto-generated or Existing">
                            </div>
                        </div>
                         <div class="form-row">
                             <div class="form-group form-group-half">
                                <label for="order_date">Order Date:</label>
                                <input type="date" id="order_date" name="order_date" required>
                            </div>
                            <div class="form-group form-group-half">
                                <label for="delivery_date">Delivery Date:</label>
                                <input type="date" id="delivery_date" name="delivery_date">
                            </div>
                        </div>
                    </div>

                    <div class="form-section-card">
                        <div class="section-title">5. Priority & Remarks</div>
                        <div class="form-row">
                            <div class="form-group priority-group">
                                <label>Urgent?</label>
                                <div class="radio-group">
                                      <label><input type="radio" name="urgent" value="Yes"> Yes</label>
                                     <label><input type="radio" name="urgent" value="No" checked> No</label>
                                 </div>
                            </div>
                            <div class="form-group remarks-group">
                                 <label for="remarks">Remarks:</label>
                                <textarea id="remarks" name="remarks" placeholder="Any specific notes..."></textarea>
                            </div>
                        </div>
                    </div>

                </div></div><div class="form-section-card">
                <div class="section-title">4. Product & Job Details</div>
                <div class="product-input-area">
                    <div class="product-entry-group">
                        <div class="form-group product-name-group">
                            <label for="product_name_input">Product Name:</label>
                             <input type="text" id="product_name_input" name="product_name_input" placeholder="Enter product name..." autocomplete="off">
                            <div id="product-suggestions" class="suggestions-box"></div>
                        </div>
                         <div class="form-group product-qty-group">
                             <label for="quantity_input">Qty:</label>
                            <input type="number" id="quantity_input" name="quantity_input" placeholder="Qty">
                        </div>
                        <button type="button" id="add-product-btn" class="add-product-button">
                             <i class="fas fa-plus"></i> Add Product
                        </button>
                    </div>
                     <p class="info-text">*New product cannot be added here, only select an existing one.</p>
                </div>
                <div id="product-list" class="product-list-container">
                    </div>
            </div><div class="button-container">
                <button type="submit" class="save-button" id="saveOrderBtn">
                     <i class="fas fa-save"></i> <span>Save Order</span>
                </button>
                <button type="button" onclick="window.location.href='order_history.html'" class="cancel-button">
                    Cancel
                </button>
            </div>
        </form>
    </div>

    <div id="whatsapp-reminder-popup" class="popup-overlay">
         <div class="popup-content">
            <button id="popup-close-btn" class="popup-close" title="Close">&times;</button>
            <h4>Order Saved Successfully!</h4>
            <p>Send update to customer?</p>
            <div id="whatsapp-message-preview" class="message-preview"></div>
             <a href="#" id="whatsapp-send-link" class="button whatsapp-send-btn" target="_blank">
                <i class="fab fa-whatsapp"></i> Send on WhatsApp
            </a>
        </div>
    </div>

    <script src="js/new_order.js" type="module" defer></script>
</body>
</html>