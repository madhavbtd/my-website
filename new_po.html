<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New/Edit Purchase Order</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/new_po.css"> <link rel="stylesheet" href="css/index.css"> <script type="module">
        // --- Firebase Setup ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import {
            getFirestore, collection, doc, addDoc, getDoc, getDocs, updateDoc, serverTimestamp,
            query, where, orderBy, limit, Timestamp // Ensure all needed are imported
         } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

         // **** Your Firebase Configuration ****
         // !! सुनिश्चित करें कि ये मान सही हैं और सुरक्षित रखे गए हैं !!
         const firebaseConfig = {
           apiKey: "YOUR_API_KEY", // वास्तविक कॉन्फ़िगरेशन से बदलें
           authDomain: "YOUR_AUTH_DOMAIN",   // वास्तविक कॉन्फ़िगरेशन से बदलें
           projectId: "YOUR_PROJECT_ID",                // वास्तविक कॉन्फ़िगरेशन से बदलें
           storageBucket: "YOUR_STORAGE_BUCKET",   // वास्तविक कॉन्फ़िगरेशन से बदलें
           messagingSenderId: "YOUR_MESSAGING_SENDER_ID",             // वास्तविक कॉन्फ़िगरेशन से बदलें
           appId: "YOUR_APP_ID" // वास्तविक कॉन्फ़िगरेशन से बदलें
         };
         // !!!!! ENSURE THESE VALUES ARE CORRECT !!!!!

        let app;
        let auth;
        let db;

        try {
             console.log("new_po.html: Attempting Firebase initialization...");
             if (!window.firebaseAppInitialized) {
                 app = initializeApp(firebaseConfig);
                 window.firebaseAppInitialized = true;
                 window.firebaseApp = app;
                 console.log("Firebase initialized on new_po.html");
             } else {
                 app = window.firebaseApp;
                 console.log("Firebase already initialized (new_po.html)");
             }
             auth = getAuth(app);
             db = getFirestore(app);
             console.log("new_po.html: Auth and Firestore instances obtained.");

             // Make Firestore functions globally available for new_po.js
             window.db = db;
             window.collection = collection;
             window.doc = doc;
             window.addDoc = addDoc;
             window.getDoc = getDoc;
             window.getDocs = getDocs;
             window.updateDoc = updateDoc;
             window.serverTimestamp = serverTimestamp;
             window.Timestamp = Timestamp;
             window.query = query;
             window.where = where;
             window.orderBy = orderBy;
             window.limit = limit;
             console.log("new_po.html: Firestore functions made global.");

             // --- Authentication Check ---
             onAuthStateChanged(auth, (user) => {
                 // Redirect logic can be adjusted based on application flow
                 const currentPage = window.location.pathname.split('/').pop().toLowerCase();
                 // Example: Redirect from specific pages if not logged in
                 if (!user && currentPage !== 'login.html' /* && other public pages */ ) {
                    console.log("User not logged in on protected page. Redirecting...");
                    // Consider where to redirect, maybe keep them on page with limited function?
                    // window.location.replace('login.html');
                 } else if (user) {
                     console.log("new_po.html: User is logged in:", user.uid);
                 } else {
                     console.log("new_po.html: User not logged in, but on a public page or handling is different.");
                 }
             });

        } catch(e) {
            console.error("new_po.html: Firebase setup error:", e);
            // Provide user-friendly error message
            const errorDiv = document.createElement('div');
            errorDiv.textContent = "एप्लिकेशन कॉन्फ़िगरेशन लोड करने में त्रुटि। कृपया बाद में पुनः प्रयास करें।";
            errorDiv.style.color = 'red';
            errorDiv.style.padding = '20px';
            errorDiv.style.textAlign = 'center';
            document.body.prepend(errorDiv); // Add error message at the top
        }
    </script>

</head>
<body>
    <div class="container">
         <div class="main-content">
            <div class="page-header">
                <h1 id="poPageTitle"><i class="fas fa-file-alt"></i> Create New Purchase Order</h1>
            </div>

            <div class="breadcrumb">
                <a href="index.html">Dashboard</a> / <a href="supplier_management.html">Suppliers & POs</a> / <span id="poBreadcrumbAction">Create PO</span>
            </div>

            <form id="poForm">
                <input type="hidden" id="editPOId">

                <div class="form-section">
                    <h2>Supplier & PO Details</h2>
                    <div class="form-row">
                        <div class="form-group supplier-search-group">
                            <label for="supplierSearchInput">Supplier <span class="required">*</span></label>
                            <input type="text" id="supplierSearchInput" class="form-input" placeholder="Type to search supplier..." required autocomplete="off">
                            <input type="hidden" id="selectedSupplierId">
                            <input type="hidden" id="selectedSupplierName">
                            <div id="supplierSuggestions" class="suggestions-list"></div>
                            <button type="button" id="addNewSupplierFromPO" class="button link-button">+ Add New Supplier</button>
                         </div>
                        <div class="form-group">
                            <label for="poNumberInput">PO Number</label>
                            <input type="text" id="poNumberInput" class="form-input" placeholder="Auto-generated" readonly>
                        </div>
                        <div class="form-group">
                            <label for="poOrderDateInput">Order Date <span class="required">*</span></label>
                            <input type="date" id="poOrderDateInput" class="form-input" required>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2>Items</h2>
                    <div class="table-container po-items-table">
                        <table id="poItemsTable">
                            <thead>
                                <tr>
                                    <th style="width: 18%;">Product Name *</th>
                                    <th style="width: 10%;">Unit Type *</th>
                                    <th style="width: 15%;" class="sq-feet-header hidden-col">Dimensions (W x H) *</th>
                                    <th style="width: 8%;" class="sq-feet-header hidden-col">Unit *</th>
                                    <th style="width: 8%;" class="qty-header">Quantity *</th>
                                    <th style="width: 10%;">Rate *</th>
                                    <th style="width: 12%;">Party Name</th>
                                    <th style="width: 12%;">Design Details</th>
                                    <th style="width: 12%;">Amount</th>
                                    <th style="width: 5%;">Action</th>
                                </tr>
                            </thead>
                            <tbody id="poItemsTableBody">
                                </tbody>
                        </table>
                    </div>
                    <button type="button" id="addItemBtn" class="button add-item-button"><i class="fas fa-plus"></i> Add Item</button>

                     <div id="calculationPreviewArea" class="calculation-preview full-preview" style="display: block;"> </div>
                </div>

                <div class="form-section po-summary">
                    <h2>Summary</h2>
                     <div class="form-group">
                         <label for="poNotesInput">Notes</label>
                         <textarea id="poNotesInput" class="form-input" rows="3" placeholder="Add any notes for the supplier or internal reference..."></textarea>
                     </div>
                     <div class="total-amount-display">
                        <strong>Total Amount:</strong> ₹ <span id="poTotalAmount">0.00</span>
                     </div>
                </div>

                 <div class="form-actions">
                     <a href="supplier_management.html" class="button cancel-button">Cancel</a>
                     <button type="submit" id="savePOBtn" class="button save-button">
                         <i class="fas fa-save"></i> <span>Save Purchase Order</span>
                     </button>
                 </div>
                 <div id="poErrorMsg" class="error-message" style="display: none;"></div>

            </form>

            <template id="item-row-template">
                <tr class="item-row">
                    <td><input type="text" class="form-input product-name" placeholder="Product Name" required></td>

                    <td>
                        <select class="form-input unit-type-select">
                            <option value="Qty" selected>Qty</option>
                            <option value="Sq Feet">Sq Feet</option>
                        </select>
                    </td>

                    <td class="sq-feet-input col-dimensions" style="display: none;">
                        <div> <input type="number" step="0.01" class="form-input dimension-input width-input" placeholder="W">
                            <span style="align-self: center;">&times;</span> <input type="number" step="0.01" class="form-input dimension-input height-input" placeholder="H">
                        </div>
                    </td>

                    <td class="sq-feet-input col-unit" style="display: none;">
                        <select class="form-input dimension-unit-select">
                            <option value="feet" selected>Feet</option>
                            <option value="inches">Inches</option>
                        </select>
                    </td>

                    <td class="qty-input col-number">
                        <input type="number" step="1" class="form-input quantity-input" placeholder="Qty" min="1">
                    </td>

                    <td class="col-number">
                        <input type="number" step="0.01" class="form-input rate-input" placeholder="Rate" required>
                    </td>

                    <td><input type="text" class="form-input party-name" placeholder="Party Name"></td>

                    <td><input type="text" class="form-input design-details" placeholder="Design Details"></td>

                    <td class="col-number col-amount">
                        <span class="item-amount">0.00</span>
                    </td>

                    <td class="col-action">
                        <button type="button" class="button delete-item-btn" title="Remove Item">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>
            </template>
            </div> </div> <script src="js/new_po.js" type="module" defer></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

</body>
</html>