<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Management</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/product_management.css"> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script type="module">
        // Import Firebase services
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        // Import other services like Firestore if needed by the page
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"; // Added Firestore imports needed for original script

        // **** Your Firebase Configuration ****
         const firebaseConfig = {
           apiKey: "AIzaSyBQj5rQmE77kKKGYixP8y3Hcimz8tiAqzQ", // Your apiKey
           authDomain: "madhav-multyprint.firebaseapp.com", // Your authDomain
           projectId: "madhav-multyprint", // Your projectId
           storageBucket: "madhav-multyprint.appspot.com", // Your storageBucket
           messagingSenderId: "104988349637", // Your messagingSenderId
           appId: "1:104988349637:web:faf045b77c6786a4e70cac" // Your appId
         };

        let app;
        let auth;
        let db; // Example for Firestore

        try {
             // Initialize Firebase App (only once per page load)
             if (!window.firebaseAppInitialized) {
                 app = initializeApp(firebaseConfig);
                 window.firebaseAppInitialized = true;
                 window.firebaseApp = app; // Store globally
                 console.log("Firebase initialized on this page (product_management).");
             } else {
                 app = window.firebaseApp; // Use existing instance
                 console.log("Firebase already initialized on this page (product_management).");
             }
             auth = getAuth(app);
             db = getFirestore(app); // Initialize Firestore (or other services)
             window.db = db; // Make global if needed by other scripts on the page
             window.auth = auth; // Make auth global

             // Make other Firestore functions globally available if product_management.js needs them
             window.collection = collection;
             window.doc = doc;
             window.addDoc = addDoc;
             window.updateDoc = updateDoc;
             window.deleteDoc = deleteDoc;
             window.onSnapshot = onSnapshot;
             window.query = query;
             window.orderBy = orderBy;
             window.serverTimestamp = serverTimestamp;


             // ---->> Authentication State Check (Core Security) <<----
             onAuthStateChanged(auth, (user) => {
                 const currentPage = window.location.pathname.split('/').pop() || 'index.html'; // Get current file name

                 if (user) {
                     // User is logged in. Allow page to load.
                     console.log(`User is logged in on ${currentPage}:`, user.uid);
                     // Initialize page-specific functions if needed
                     // e.g., if (typeof initializeProductManagement === 'function') { initializeProductManagement(user); }

                 } else {
                     // User is not logged in.
                     console.log(`User is not logged in on ${currentPage}. Redirecting to login...`);
                     // Redirect to login.html from all protected pages (but NOT from login.html itself)
                     if (currentPage.toLowerCase() !== 'login.html') {
                        // Make sure 'login.html' path is correct relative to your files
                        window.location.replace('login.html');
                     }
                 }
             });
             // ---->> Auth check end <<----

             // --- Logout Link Logic (Include if a logout link exists on this page) ---
             // Assuming no logout link on this specific page based on original code,
             // but you can add it here if needed, similar to index.html


             // --- Optional: Make user info available globally ---
             window.getCurrentUser = () => {
                 return auth.currentUser;
             };

        } catch(e) {
            console.error("Firebase setup / Auth check error:", e);
            alert("Error loading application. Please try again later."); // English alert
            // Optional: Redirect to login on critical error
            // if (window.location.pathname.split('/').pop().toLowerCase() !== 'login.html') {
            //    window.location.replace('login.html');
            // }
        }
    </script>
    </head>
<body>
    <div class="container">
        <div class="header">
            <i class="fas fa-box-open header-icon"></i>
            <h1>Product Management</h1>
        </div>

        <div class="breadcrumb-container">
          <a href="index.html">Home</a> / Product Management
          </div>
        <div class="filter-bar">
              <div class="filter-group">
                 <button id="addNewProductBtn" class="button add-new-button">
                    <i class="fas fa-plus"></i> Add New Product
                </button>
            </div>
             <div class="filter-group">
                 <label for="filterSearch"><i class="fas fa-search"></i> Search:</label>
                <input type="text" id="filterSearch" placeholder="Product Name...">
            </div>
             <div class="filter-group filter-sort">
                <label for="sort-products"><i class="fas fa-sort"></i> Sort by:</label>
                <select id="sort-products">
                     <option value="createdAt_desc">Newest First</option>
                    <option value="createdAt_asc">Oldest First</option>
                    <option value="printName_asc">Name (A-Z)</option>
                    <option value="printName_desc">Name (Z-A)</option>
                     <option value="price_asc">Price (Low-High)</option>
                    <option value="price_desc">Price (High-Low)</option>
                 </select>
            </div>
            <div class="filter-group">
                 <button id="clearFiltersBtn" class="button clear-filters-button" title="Clear search and reset sort">
                     <i class="fas fa-times"></i> Clear
                 </button>
            </div>
        </div>

        <div class="table-container">
            <table id="productTable">
                <thead>
                     <tr>
                        <th>Product Name</th>
                        <th>Price</th> <th>Category</th> <th>Actions</th>
                    </tr>
                 </thead>
                <tbody id="productTableBody">
                    <tr>
                        <td colspan="4" id="loadingMessage">Loading products...</td>
                    </tr>
                 </tbody>
            </table>
        </div>
    </div>

    <div id="productModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeProductModal" title="Close">&times;</span>
            <h2 id="modalTitle">Add New Product</h2>
            <form id="productForm">
                <input type="hidden" id="editProductId">
                <div class="form-group">
                    <label for="productPrintName">Product Name (Print Name) <span class="required">*</span>:</label>
                    <input type="text" id="productPrintName" required placeholder="Name shown in order form">
                </div>
                <div class="form-group">
                     <label for="productPrice">Price:</label>
                    <input type="number" id="productPrice" placeholder="e.g., 150.00" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="productCategory">Category:</label>
                     <input type="text" id="productCategory" placeholder="e.g., Visiting Card, Banner">
                </div>
                <div class="form-group">
                    <label for="productGroup">Product Group:</label>
                    <input type="text" id="productGroup" placeholder="e.g., Paper, Flex, Binding">
                </div>
                <div class="form-group">
                    <label for="productUnit">Unit:</label>
                    <select id="productUnit">
                        <option value="">-- Select Unit --</option>
                        <option value="qty">qty</option>
                        <option value="sq feet">sq feet</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="submit" id="saveProductBtn" class="button save-button">
                        <i class="fas fa-save"></i> <span>Save Product</span>
                    </button>
                     <button type="button" id="cancelProductBtn" class="button cancel-button">
                        Cancel
                    </button>
                 </div>
            </form>
        </div>
    </div>

    <script src="js/product_management.js" type="module" defer></script>

</body>
</html>